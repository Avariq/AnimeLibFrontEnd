<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8" />
    <title>AnimeLib</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&display=swap" rel="stylesheet">
    <link href="/CSS/main.css" rel="stylesheet" />
    <script src="../JS/jquery-3.6.0.min.js"></script>
    <script src="../JS/global.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo"><a class="logo-link" href="../index.html?page=1">AnimeLib</a></div>
            <ul class="menu">
                <li><a id="admin-page" class="admin-page" href="HTML/AdminPage.html"> Admin page </a></li>
                <li><a id="random-anime" href="#">Random Anime</a></li>
                <li id="login" class="login"><a href="HTML/Login.html">Log in</a></li>
                <li id="logout" class="logout"><a href="index.html?page=1">Log out</a></li>
            </ul>
        </div>
    </nav>
    <div class="content">
        <div class="container">
            <div class="anime-block">
                <div class="anime-container">
                    <div class="header-block">
                        <h1 id="title"></h1>
                        <div class="rating-info">
                            <span class="main-rating" id="rating"></span>
                            <p id="votes"></p>
                        </div>
                    </div>
                </div>
                <div class="anime-container">
                    <div class="anime-main-info-block">
                        <div id="anime-image-block">
                            <img src="#" id="anime-image" />
                        </div>
                        <ul id="content-main-info"></ul>
                    </div>
                </div>
                <div class="anime-container">
                    <div class="content-desc">
                        <div id="content-desc-text"></div>
                        <div class="spoiler-block">
                            <div id="spoiler-title">
                                <p>Episode list (Arcs + Fillers)</p>
                            </div>
                            <div id="spoiler-content">
                                <div class="spoiler">
                                    <div class="spoiler-title">
                                        <p></p>
                                    </div>
                                    <div class="spoiler-content">
        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        $.extend({
            getUrlVars: function () {
                var vars = [], hash;
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    if (vars[hash[0]]) {
                        vars[hash[0]].push(hash[1]);
                    }
                    else {
                        vars.push(hash[0]);
                        vars[hash[0]] = [];
                        vars[hash[0]].push(hash[1]);
                    }
                }
                return vars;
            }
        });
        $.extend({
            getAnimeById: function (id) {
                var anime = null;
                $.ajax({
                    type: "get",
                    url: "https://localhost:5001/api/Anime/GetAnimeById?animeId=" + id,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        anime = data;
                    },
                    error: function (errorThrown) {
                        console.log(errorThrown);
                    }
                });
                return anime;
            }
        });

        $("#spoiler-title").click(function () {
            $("#spoiler-content").toggle(200);
        });

        function displayAnime() {
            vars = $.getUrlVars();
            var animeId = parseInt(vars["Id"]);
            var anime = $.getAnimeById(animeId);
            console.log(anime);
            console.log(anime.image);
            $("#anime-image").attr('src', '../' + anime.image);
            $("#title").text(anime.title);
            $("#rating").text(anime.rating);
            $("#votes").text("Votes: " + anime.votes);
            $("#content-main-info").append('<li> Views: ' + anime.views + '</li>');
            $("#content-main-info").append('<li> <span>Status:</span><span id="stat">' + anime.status.statusName + '</span></li>');
            $("#content-main-info").append('<li> Year: ' + anime.year + '</li>');
            $("#content-main-info").append('<li> Age restriction: ' + anime.ageRestriction.restrictionCode + ' (' + anime.ageRestriction.ageRequired + '+)' + '</li>');
            $("#content-main-info").append('<li id="genres"> Genres: </li>');
            for (var i = 0; i < anime.genres.length; i++) {
                $("#genres").append("<p>" + anime.genres[i].genre.name + ' ' + "</p>");
            }
            $("#content-main-info").append('<li> Episodes: ' + anime.episodes + '</li>');
            $("#content-desc-text").append('<p>' + anime.description + '</p>');
            var arcBlock = $(".spoiler");
            $(".spoiler").hide();
            var counter = 1;
            for (var i = 0; i < anime.arcs.length; i++) {
                var newArcBlock = arcBlock.clone();
                newArcBlock.find(".spoiler-title > p").text("Arc #" + (i + 1) + ": " + anime.arcs[i].name);
                for (var j = 0; j < anime.arcs[i].episodes.length; j++) {
                    var episode = anime.arcs[i].episodes[j];
                    newArcBlock.find(".spoiler-content").append("<p>" + counter + ". " + episode.name + " (" + episode.duration + " minutes)" + "</p > ");
                    counter += 1;
                    newArcBlock.find(".spoiler-content").hide();
                }
                newArcBlock.show();
                $("#spoiler-content").append(newArcBlock);
            }

            var status = anime.status.statusName;
            if (status == "Released") {
                $("#stat").addClass("released");
            }
            else if (status == "Ongoing") {
                $("#stat").addClass("ongoing");
            }
            else if (status == "Announced") {
                $("#stat").addClass("announced");
            }
        }

        var timer;

        $(document).ready(function () {
            displayAnime();
            setExpiration();
            RandomAnime();
            displayAdminPage();
            displayLogInOut();
            timer = window.setInterval(refreshExpiration, 5000);
        });

        $("#spoiler-content").on("click", ".spoiler-title", function (event) {
            $(this).siblings(".spoiler-content").toggle(200);
        });



    </script>
</body >
</html >
